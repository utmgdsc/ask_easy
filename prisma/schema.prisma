// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  STUDENT
  TA
  PROFESSOR
}

enum SessionStatus {
  SCHEDULED
  ACTIVE
  ENDED
}

enum Visibility {
  PUBLIC
  INSTRUCTOR_ONLY
}

enum QuestionStatus {
  OPEN
  ANSWERED
  RESOLVED
}

// ============================================================================
// MODELS
// ============================================================================

model User {
  id     String @id @default(cuid())
  utorid String @unique
  email  String @unique
  name   String
  role   Role   @default(STUDENT)

  // Relations
  enrollments     CourseEnrollment[]
  createdCourses  Course[]           @relation("CourseCreator")
  createdSessions Session[]          @relation("SessionCreator")
  questions       Question[]
  answers         Answer[]
  upvotes         QuestionUpvote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
}

model Course {
  id          String @id @default(cuid())
  code        String
  name        String
  semester    String
  createdById String

  // Relations
  createdBy   User               @relation("CourseCreator", fields: [createdById], references: [id])
  enrollments CourseEnrollment[]
  sessions    Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([code, semester])
  @@index([createdById])
  @@index([semester])
}

model CourseEnrollment {
  id       String @id @default(cuid())
  userId   String
  courseId String
  role     Role   @default(STUDENT)

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Session {
  id                   String        @id @default(cuid())
  courseId             String
  createdById          String
  title                String
  joinCode             String        @unique
  status               SessionStatus @default(SCHEDULED)
  isSubmissionsEnabled Boolean       @default(true)

  // Timestamps for session lifecycle
  startTime DateTime?
  endTime   DateTime?

  // Relations
  course    Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdBy User       @relation("SessionCreator", fields: [createdById], references: [id])
  slides    Slide[]
  questions Question[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
  @@index([createdById])
  @@index([joinCode])
  @@index([status])
}

model Slide {
  id          String  @id @default(cuid())
  sessionId   String
  slideNumber Int
  contentUrl  String?

  // Relations
  session   Session    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  questions Question[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, slideNumber])
  @@index([sessionId])
}

model Question {
  id          String         @id @default(cuid())
  sessionId   String
  slideId     String?
  authorId    String? // Nullable for anonymous questions
  content     String
  isAnonymous Boolean        @default(false)
  visibility  Visibility     @default(PUBLIC)
  status      QuestionStatus @default(OPEN)
  upvoteCount Int            @default(0)

  // Relations
  session Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  slide   Slide?           @relation(fields: [slideId], references: [id], onDelete: SetNull)
  author  User?            @relation(fields: [authorId], references: [id], onDelete: SetNull)
  answers Answer[]
  upvotes QuestionUpvote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([slideId])
  @@index([authorId])
  @@index([status])
  @@index([visibility])
  @@index([createdAt])
}

model Answer {
  id         String  @id @default(cuid())
  questionId String
  authorId   String
  content    String
  isAccepted Boolean @default(false)

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  author   User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([questionId])
  @@index([authorId])
}

model QuestionUpvote {
  id         String @id @default(cuid())
  questionId String
  userId     String

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  // Unique constraint prevents duplicate upvotes
  @@unique([questionId, userId])
  @@index([questionId])
  @@index([userId])
}
